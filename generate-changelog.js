const fs = require('fs');
const gitCommits = require('git-raw-commits');
const writeStream = fs.createWriteStream('CHANGELOG.md');
const readStream = gitCommits({ format: '%s%n%an %ad %nGit hash: [%h](https://github.com/VividSeats/vivid-design-patterns/commit/%h)' });

const versionRegex = /(v\d+\.\d+\.\d+)/g;
const newLineRegex = /\r?\n/;
const newLine = '\n';

writeStream.write('# CHANGELOG');
writeStream.write(newLine);
writeStream.write('##### _auto-generated by generate-changelog.js_');
writeStream.write(newLine);

readStream
    .on('data', chunk => {
        const commitString = chunk.toString();
        const splitCommitString = commitString.split(newLineRegex);

        if (versionRegex.test(splitCommitString[0])) {
            for (let i = 0; i < splitCommitString.length - 1; i++) {
                const line = splitCommitString[i];
                const markdown = !i ? `### ${line}` : `##### ${line}`;

                writeStream.write(markdown);
                writeStream.write(newLine);
            }
        } else {
            for (let i = 0; i < splitCommitString.length - 1; i++) {
                const line = splitCommitString[i];

                writeStream.write(`  - ${line}`);
                writeStream.write(newLine);
            }
        }
    })
    .on('end', () => {
        writeStream.end();
    });
